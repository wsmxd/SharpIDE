@using Microsoft.Build.Construction
@using Microsoft.Build.Definition
@using Microsoft.Build.Execution
@using Microsoft.Build.Framework
@using Microsoft.Build.Logging
@using SharpIDE.Application.Features.SolutionDiscovery
@inherits LayoutComponentBase

@inject IDialogService DialogService

<MudLayout>
	<MudAppBar Dense="true">
		<MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
	</MudAppBar>
	<MudDrawer @bind-Open="@_drawerOpen" Width="400px" ClipMode="DrawerClipMode.Always">
		@if (_solutionFilePath is not null)
		{
			<SolutionExplorer SolutionFilePath="@_solutionFilePath"/>
		}
		@* <NavMenu/> *@
	</MudDrawer>
	<MudMainContent>
		<MudContainer MaxWidth="MaxWidth.False" Class="mt-2">
			@* @Body *@
			@if (_solutionFilePath is not null)
			{
				<CodeViewer FilePath="C:\Users\matth\Documents\Git\SharpIDE.Photino\src\SharpIDE.Photino\Program.cs" />
			}
		</MudContainer>
	</MudMainContent>
</MudLayout>

@code {
	bool _drawerOpen = true;

	void DrawerToggle()
	{
		_drawerOpen = !_drawerOpen;
	}

	private string? _solutionFilePath;

	protected override async Task OnInitializedAsync()
	{
		var dialogRef = await DialogService.ShowAsync<SolutionPickerDialog>("Open Solution", new DialogOptions { FullWidth = true, MaxWidth = MaxWidth.Medium });
		var result = await dialogRef.Result;
		if (result is null) throw new InvalidOperationException("Dialog result is null");
		if (result.Canceled) throw new OperationCanceledException("Dialog was canceled");
		var solutionFilePath = (string)result.Data!;
		_solutionFilePath = solutionFilePath;

		var buildParameters = new BuildParameters
		{
			Loggers =
			[
				//new BinaryLogger { Parameters = "msbuild.binlog" },
				new ConsoleLogger(LoggerVerbosity.Quiet),
			],
		};
		// var solutionFile = GetNodesInSolution.ParseSolutionFileFromPath(_solutionFilePath);
		// ArgumentNullException.ThrowIfNull(solutionFile);
		// var projects = GetNodesInSolution.GetCSharpProjectObjectsFromSolutionFile(solutionFile);
		// var projectRoot = projects.First();
		// var buildRequest = new BuildRequestData(
		// 	ProjectInstance.FromProjectRootElement(projectRoot, new ProjectOptions()),
		// 	targetsToBuild: ["Restore", "Build"]);
		var buildRequest = new BuildRequestData(projectFullPath : _solutionFilePath,
			globalProperties: new Dictionary<string, string?>(),
			toolsVersion: null,
			targetsToBuild: ["Restore", "Build"],
			hostServices: null,
			flags: BuildRequestDataFlags.None);
		var result2 = BuildManager.DefaultBuildManager.Build(buildParameters, buildRequest);
		Console.WriteLine(result2.OverallResult);
	}
}
